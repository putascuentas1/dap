<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dukes & Peasants — Leaderboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-0: #0a0f14;
    --bg-1: #0f1620;
    --glass: rgba(255,255,255,0.06);
    --glass-strong: rgba(255,255,255,0.12);
    --stroke: rgba(255,255,255,0.12);
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #00e5ff;      /* neon cyan */
    --accent-2: #2aff80;    /* neon green */
    --danger: #ff487a;
    --warn: #ffb84d;
    --success: #2aff80;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
    --radius: 14px;
    --radius-sm: 10px;
    --focus: 0 0 0 2px rgba(0,229,255,0.5), 0 0 0 6px rgba(0,229,255,0.15);
  }

  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    background: var(--bg-0);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
    line-height: 1.6;
  }
  body {
    margin: 0;
    overflow-y: auto;
  }

  /* High-tech background: animated radial glow + subtle grid */
  body::before, body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -2;
  }
  body::before {
    background:
      radial-gradient(60rem 60rem at 15% 10%, rgba(0,229,255,0.12), transparent 60%),
      radial-gradient(60rem 60rem at 85% 90%, rgba(42,255,128,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
  }
  body::after {
    background-image:
      linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 46px 46px, 46px 46px;
    mask-image: radial-gradient(80rem 80rem at 50% 50%, rgba(0,0,0,0.55), transparent 75%);
    animation: gridFloat 14s ease-in-out infinite alternate;
  }
  @keyframes gridFloat {
    from { transform: translateY(0) }
    to   { transform: translateY(-10px) }
  }

  /* Sticky top banner */
  .topbar{
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(10,15,20,0.9), rgba(10,15,20,0.6));
    backdrop-filter: saturate(130%) blur(12px);
    border-bottom: 1px solid var(--stroke);
  }
  .container{
    max-width: 1100px; margin: 0 auto; padding: 18px 20px;
  }
  .brand{
    display:flex; align-items:flex-start; gap:14px;
  }
  .crest{
    width: 44px; height: 44px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2));
    box-shadow: 0 0 24px rgba(0,229,255,0.45), inset 0 0 22px rgba(42,255,128,0.3);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .title{
    font-family: Orbitron, Inter, sans-serif;
    font-weight: 700; letter-spacing: 0.6px; margin:0;
    font-size: clamp(1.2rem, 1.4rem + 1vw, 2rem);
    display:flex; align-items:center; gap:8px;
    text-shadow: 0 0 20px rgba(0,229,255,0.2);
  }
  .subtitle{
    margin: 2px 0 0 0; font-size: 0.95rem; color: var(--muted);
  }
  .neon-bar{
    height: 2px; width: 100%;
    background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent);
    opacity: 0.5;
  }

  /* Main content */
  main{
    padding: 28px 20px 140px;  /* bottom padding to accommodate bottom region */
    max-width: 1100px; margin: 0 auto;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px) saturate(140%);
    overflow: hidden;
  }
  .card-header{
    display:flex; align-items:center; justify-content: space-between;
    padding: 16px 18px;
    border-bottom: 1px solid var(--stroke);
  }
  .card-title{
    margin: 0; font-size: 1.1rem; color: var(--muted); letter-spacing: 0.3px;
  }
  .actions{ display:flex; align-items:center; gap:10px; }
  .btn{
    appearance: none; border: 1px solid var(--stroke); color: var(--text);
    background: rgba(255,255,255,0.04);
    padding: 10px 14px; border-radius: 12px; font-weight: 600; letter-spacing: 0.2px;
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    cursor: pointer;
  }
  .btn:hover{ background: rgba(255,255,255,0.08); transform: translateY(-1px); }
  .btn:focus-visible{ outline: none; box-shadow: var(--focus); }
  .btn-primary{
    border-color: rgba(0,229,255,0.45);
    background: linear-gradient(180deg, rgba(0,229,255,0.15), rgba(0,229,255,0.06));
  }
  .btn-primary:hover{
    background: linear-gradient(180deg, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    box-shadow: 0 0 24px rgba(0,229,255,0.25);
  }
  .btn-ghost{
    border-color: var(--stroke);
  }
  .btn-icon{
    display:inline-flex; align-items:center; gap:8px;
  }
  .btn[disabled]{ opacity: 0.55; cursor: not-allowed; }

  .last-sync{
    color: var(--muted); font-size: 0.88rem;
  }

  /* Table */
  .table-wrap{
    width: 100%; overflow-x: auto;
  }
  table{
    width: 100%; border-collapse: collapse;
    background: transparent; font-size: 0.98rem;
  }
  thead th{
    text-align: left; font-weight: 700; color: #cfe7ff; padding: 14px 16px;
    position: sticky; top: 0; background: rgba(12,18,26,0.7); backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--stroke);
  }
  tbody td{
    padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  tbody tr{
    transition: background .15s ease;
  }
  tbody tr:nth-child(even){ background: rgba(255,255,255,0.02); }
  tbody tr:hover{ background: rgba(0,229,255,0.06); }

  .rank{
    font-weight: 700; color: #dffaff;
  }
  .player{
    max-width: 340px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding: 6px 10px;
    border-radius: 999px; font-weight: 700; font-size: 0.86rem; letter-spacing: 0.3px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.04);
  }
  .pill.yes{
    color: #032; background: rgba(42,255,128,0.18); border-color: rgba(42,255,128,0.38);
    color: #d9ffea;
  }
  .pill.no{
    color: #ffdfe9; background: rgba(255,95,120,0.16); border-color: rgba(255,95,120,0.36);
  }
  .icon{
    width: 16px; height: 16px; display:inline-block; vertical-align: middle;
  }
  .icon-lg{ width: 18px; height: 18px; }

  .score{
    font-variant-numeric: tabular-nums; font-weight: 700;
  }
  .ts{
    color: var(--muted); font-size: 0.9rem;
    white-space: nowrap;
  }

  /* Empty and error states */
  .state{
    padding: 26px; text-align: center; color: var(--muted);
  }

  /* Skeleton shimmer */
  .skeleton-row{
    display: grid; grid-template-columns: 70px 1fr 160px 140px 170px 160px;
    gap: 0;
    padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .skeleton{
    height: 14px; border-radius: 8px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
  }
  .sk1{ width:40px } .sk2{ width: 60% } .sk3{ width: 80px } .sk4{ width: 100px } .sk5{ width: 120px } .sk6{ width: 120px }
  @keyframes shimmer {
    0%{ background-position: 200% 0 }
    100%{ background-position: -200% 0 }
  }

  /* Bottom region (not a footer) */
  .bottom-region{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 40;
    padding: 12px 14px 18px;
    display:flex; justify-content: center;
    background: linear-gradient(0deg, rgba(10,15,20,0.96), rgba(10,15,20,0.88), rgba(10,15,20,0));
    border-top: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
  }
  .bottom-wrap{
    width: 100%; max-width: 1100px;
    display: grid; grid-template-columns: 1fr auto; gap: 12px;
    align-items: start;
  }
  .contract-group{
    display: grid; grid-template-columns: 1fr auto auto; gap: 10px; width: 100%;
  }
  .input{
    width: 100%; padding: 12px 12px; border-radius: 12px;
    background: rgba(255,255,255,0.06); color: var(--text);
    border: 1px solid var(--stroke); font-family: inherit; font-size: 0.98rem;
  }
  .input[readonly]{ color: #d7eaff; }
  .btn-chart{
    white-space: nowrap;
  }
  .socials{
    grid-column: 1 / -1;
    display:flex; align-items:center; gap: 10px;
    margin-top: 6px;
  }
  .social-btn{
    display:inline-flex; align-items:center; gap:10px;
    padding: 10px 12px; border-radius: 999px; text-decoration: none;
    color: var(--text); border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.04);
    transition: transform .15s ease, background .2s, box-shadow .2s ease;
  }
  .social-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.08); }
  .social-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Floating FAQ button */
  .help-btn{
    position: fixed; right: 18px; bottom: 96px; z-index: 45;
    width: 54px; height: 54px; border-radius: 50%;
    display:grid; place-items:center;
    border: 1px solid rgba(0,229,255,0.35);
    background: radial-gradient(circle at 30% 30%, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    color: var(--text);
    box-shadow: 0 0 22px rgba(0,229,255,0.2);
  }
  .help-btn:hover{ box-shadow: 0 0 28px rgba(0,229,255,0.3); transform: translateY(-1px); }
  .help-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Modal */
  .overlay{
    position: fixed; inset: 0; z-index: 100; display:none;
    background: rgba(5,8,12,0.7);
    backdrop-filter: blur(8px) saturate(120%);
  }
  .overlay.open{ display:block; }
  .modal{
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    width: min(760px, calc(100% - 32px));
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal-header{
    display:flex; justify-content: space-between; align-items:center; padding: 14px 16px;
    border-bottom: 1px solid var(--stroke);
  }
  .modal-title{
    margin: 0; font-family: Orbitron, Inter, sans-serif; letter-spacing: 0.6px;
  }
  .modal-body{
    max-height: min(70vh, 720px); overflow: auto; padding: 16px;
  }
  .faq{
    display: grid; gap: 14px;
  }
  .faq-item{
    background: rgba(255,255,255,0.04); border: 1px solid var(--stroke);
    border-radius: var(--radius-sm); padding: 14px 14px;
  }
  .faq-item h4{ margin: 0 0 6px 0; }
  .close-btn{
    width: 36px; height: 36px; border-radius: 10px;
    display:grid; place-items:center;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.06);
  }
  .close-btn:hover{ background: rgba(255,255,255,0.1); }
  .close-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Toast */
  .toast{
    position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; z-index: 120;
    background: rgba(7,11,16,0.92); color: var(--text);
    border: 1px solid rgba(0,229,255,0.35);
    padding: 10px 14px; border-radius: 12px;
    display: none; align-items: center; gap: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  }
  .toast.show{ display: inline-flex; animation: toastIn .2s ease; }
  @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 6px) } to { opacity: 1; transform: translate(-50%, 0) } }

  /* Responsive: stack table rows on small screens */
  @media (max-width: 780px){
    thead{ display: none; }
    table, tbody, tr, td{ display: block; width: 100%; }
    tbody tr{ border-bottom: 1px solid rgba(255,255,255,0.06); padding: 10px 6px; }
    tbody td{
      border: none; padding: 8px 10px;
      display:flex; justify-content: space-between; align-items:center; gap: 12px;
    }
    tbody td::before{
      content: attr(data-label);
      color: var(--muted); font-weight: 600; letter-spacing: 0.3px;
    }
    .skeleton-row{ grid-template-columns: 1fr; gap: 10px; }
    .player { max-width: none; }
    .bottom-wrap{
      grid-template-columns: 1fr; gap: 10px;
    }
    .contract-group{
      grid-template-columns: 1fr auto; grid-auto-rows: auto;
    }
  }

  /* Focus visible for inputs */
  .input:focus-visible{ outline: none; box-shadow: var(--focus); }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="container">
      <div class="brand" aria-label="Project brand">
        <div class="crest" aria-hidden="true" title="Project crest glow"></div>
        <div>
          <h1 class="title">Dukes &amp; Peasants <span style="color:var(--accent)">•</span></h1>
          <p class="subtitle">A high-stakes on-chain tale—rise from peasant to duke and etch your name on the board.</p>
        </div>
      </div>
    </div>
    <div class="neon-bar" aria-hidden="true"></div>
  </header>

  <main id="main">
    <section class="card" aria-label="Leaderboard">
      <div class="card-header">
        <h2 class="card-title">Leaderboard</h2>
        <div class="actions">
          <span class="last-sync" id="lastSync" aria-live="polite"></span>
          <button id="refreshBtn" class="btn btn-ghost btn-icon" aria-label="Refresh leaderboard" title="Refresh">
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 12a9 9 0 1 1-2.64-6.36" />
              <path d="M21 3v6h-6" />
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table aria-describedby="leaderboard-desc">
          <caption id="leaderboard-desc" style="position:absolute;left:-9999px;opacity:0;">Sorted by Beat the Game (Yes first), then by Score descending.</caption>
          <thead>
            <tr>
              <th scope="col">Rank</th>
              <th scope="col">Player</th>
              <th scope="col">Beat the Game</th>
              <th scope="col">Score</th>
              <th scope="col">Acquired Follower</th>
              <th scope="col">Last Updated</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Skeleton rows (shown before data loads) -->
          </tbody>
        </table>
      </div>
      <div id="state" class="state" style="display:none;"></div>
    </section>
  </main>

  <!-- Bottom Region (no footer element) -->
  <div class="bottom-region" role="complementary" aria-label="Project links and contract info">
    <div class="bottom-wrap">
      <div class="contract-group">
        <input id="contractInput" class="input" type="text" readonly value="" aria-label="Contract address (readonly)" title="Contract address" />
        <button id="copyBtn" class="btn btn-icon" aria-label="Copy contract address" title="Copy">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <a id="chartBtn" class="btn btn-primary btn-icon btn-chart" target="_blank" rel="noopener noreferrer" aria-label="Open Dexscreener chart in new tab" title="Dexscreener">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 13V6a2 2 0 0 0-2-2H6" />
            <rect x="8" y="8" width="12" height="12" rx="2" />
            <path d="M12 12l3 3 4-5" />
          </svg>
          Chart
        </a>

        <div class="socials" aria-label="Social links">
          <a id="twitterLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter" title="Twitter">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M22 5.8c-.7.3-1.5.5-2.2.6.8-.5 1.4-1.2 1.7-2.1-.8.5-1.7.9-2.6 1.1A3.8 3.8 0 0 0 12 7.9c0 .3 0 .6.1.8A10.8 10.8 0 0 1 3 5.2a3.8 3.8 0 0 0 1.2 5.1c-.6 0-1.2-.2-1.7-.5v.1c0 1.8 1.3 3.3 3 3.7-.3.1-.7.1-1 .1-.2 0-.5 0-.7-.1.5 1.5 2 2.6 3.7 2.6A7.7 7.7 0 0 1 2 18.6 10.9 10.9 0 0 0 7.9 20c6.6 0 10.3-5.5 10.3-10.3v-.5c.7-.5 1.3-1.1 1.8-1.8z"/>
            </svg>
            Twitter
          </a>
          <a id="discordLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Discord" title="Discord">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M20.3 4.4A18 18 0 0 0 15.9 3l-.3.6c1.5.4 2.6 1 3.5 1.7-1.6-.8-3.3-1.4-5-1.7A17.6 17.6 0 0 0 8.1 4C6.7 4.6 5.7 5.2 4.8 6c.9-.7 2.1-1.3 3.5-1.7l-.3-.6a18 18 0 0 0-4.4 1.4C1.2 8 0 12 0 16.1c0 0 2.2 3 8.1 3.2l1-1.3c-.6-.2-1.3-.6-2-1.2 1.4.9 3.1 1.6 5 1.7 1.9-.1 3.6-.8 5-1.7-.7.6-1.4 1-2 1.2l1 1.3c5.9-.2 8.1-3.2 8.1-3.2 0-4.1-1.2-8-3.9-11.7zM8.7 14.7c-.8 0-1.4-.7-1.4-1.5s.6-1.5 1.4-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm6.6 0c-.8 0-1.5-.7-1.5-1.5s.7-1.5 1.5-1.5 1.5.7 1.5 1.5-.7 1.5-1.5 1.5z"/>
            </svg>
            Discord
          </a>
          <a id="telegramLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Telegram" title="Telegram">
            <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M9.04 15.29l-.37 5.3c.53 0 .76-.23 1.03-.5l2.48-2.38 5.14 3.76c.94.52 1.6.25 1.85-.86l3.36-15.8h.01c.3-1.4-.5-1.95-1.4-1.6L1.3 9.68c-1.35.53-1.33 1.28-.23 1.62l5.7 1.78 13.27-8.38c.62-.42 1.18-.19.72.23L9.04 15.29z"/>
            </svg>
            Telegram
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Help Button -->
  <button id="helpBtn" class="help-btn" aria-haspopup="dialog" aria-controls="faqOverlay" aria-label="Open FAQ" title="FAQ">
    <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M9.1 9.5a3 3 0 0 1 5.7 1c0 2-3 2-3 4"></path>
      <circle cx="12" cy="17" r="0.8" fill="currentColor" stroke="none"></circle>
    </svg>
  </button>

  <!-- FAQ Modal -->
  <div id="faqOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
      <div class="modal-header">
        <h3 id="faqTitle" class="modal-title">FAQ — Dukes &amp; Peasants</h3>
        <button id="closeFaqBtn" class="close-btn" aria-label="Close FAQ" title="Close">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="faq">
          <div class="faq-item">
            <h4>What is Dukes &amp; Peasants?</h4>
            <p>A choice-driven, on-chain adventure where players compete for glory. Your decisions affect your score and whether you beat the game.</p>
          </div>
          <div class="faq-item">
            <h4>How does the leaderboard work?</h4>
            <p>Entries are sorted with players who beat the game shown first, then by highest score. Updates appear in near real-time.</p>
          </div>
          <div class="faq-item">
            <h4>What does “Acquired Follower” mean?</h4>
            <p>If you recruited a follower during your run, you will see a green check. Otherwise, a red cross appears.</p>
          </div>
          <div class="faq-item">
            <h4>Why is my name truncated?</h4>
            <p>Very long player names are truncated to keep the table readable on all devices. Hover to see the full name in the title tooltip.</p>
          </div>
          <div class="faq-item">
            <h4>How often is data refreshed?</h4>
            <p>There is a manual refresh, and the page also listens for new entries or updates and re-fetches automatically.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I view the token chart?</h4>
            <p>Use the Chart button at the bottom to open the Dexscreener page in a new tab.</p>
          </div>
          <div class="faq-item">
            <h4>Who maintains this project?</h4>
            <p>The Dukes &amp; Peasants team and community. Join us on Twitter, Discord, and Telegram via the links at the bottom.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast + SR live region -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <path d="M20 6L9 17l-5-5" />
    </svg>
    <span id="toastMsg">Copied!</span>
  </div>
  <div id="srAnnounce" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-live="polite"></div>

<script type="module">
  // TODO: Insert your real configuration values below before deploying.
  const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';         // TODO
  const SUPABASE_ANON_KEY = 'YOUR-ANON-KEY';                       // TODO
  const TABLE_NAME = 'leaderboard';                                // TODO if different
  const CONTRACT_ADDRESS = '0x0000000000000000000000000000000000000000'; // TODO
  const DEXSCREENER_URL = 'https://dexscreener.com/your-chain/your-pair'; // TODO
  const TWITTER_URL = 'https://twitter.com/your-handle';           // TODO
  const DISCORD_URL = 'https://discord.gg/your-invite';            // TODO
  const TELEGRAM_URL = 'https://t.me/your-channel';                // TODO

  // Import Supabase client (ESM)
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Initialize client
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM references
  const tbody = document.getElementById('tbody');
  const stateEl = document.getElementById('state');
  const refreshBtn = document.getElementById('refreshBtn');
  const lastSyncEl = document.getElementById('lastSync');
  const contractInput = document.getElementById('contractInput');
  const copyBtn = document.getElementById('copyBtn');
  const chartBtn = document.getElementById('chartBtn');
  const twitterLink = document.getElementById('twitterLink');
  const discordLink = document.getElementById('discordLink');
  const telegramLink = document.getElementById('telegramLink');
  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  const srAnnounce = document.getElementById('srAnnounce');

  const helpBtn = document.getElementById('helpBtn');
  const faqOverlay = document.getElementById('faqOverlay');
  const closeFaqBtn = document.getElementById('closeFaqBtn');

  // Apply config to UI
  contractInput.value = CONTRACT_ADDRESS;
  chartBtn.href = DEXSCREENER_URL;
  twitterLink.href = TWITTER_URL;
  discordLink.href = DISCORD_URL;
  telegramLink.href = TELEGRAM_URL;

  // Accessible announce helper
  function announce(msg){
    srAnnounce.textContent = '';
    setTimeout(()=>{ srAnnounce.textContent = msg; }, 10);
  }

  // Toast helper
  let toastTimer = null;
  function showToast(message = 'Copied!'){
    toastMsg.textContent = message;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
  }

  // Icons (as strings to embed)
  const iconCheck = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M20 6L9 17l-5-5" /></svg>';
  const iconCross = '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M18 6L6 18" /><path d="M6 6l12 12" /></svg>';

  // Skeleton renderer
  function renderSkeleton(count = 6){
    stateEl.style.display = 'none';
    tbody.innerHTML = '';
    for(let i=0;i<count;i++){
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Rank"><div class="skeleton sk1"></div></td>
        <td data-label="Player"><div class="skeleton sk2"></div></td>
        <td data-label="Beat the Game"><div class="skeleton sk3"></div></td>
        <td data-label="Score"><div class="skeleton sk4"></div></td>
        <td data-label="Acquired Follower"><div class="skeleton sk5"></div></td>
        <td data-label="Last Updated"><div class="skeleton sk6"></div></td>
      `;
      tbody.appendChild(row);
    }
  }

  // Format helpers
  const formatNumber = (n)=> typeof n === 'number' ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '-';
  function formatDate(ts){
    if(!ts) return '-';
    try {
      const d = new Date(ts);
      if (isNaN(d.getTime())) return '-';
      // ISO-like short format
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    } catch { return '-'; }
  }

  // Render rows
  function renderRows(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length === 0){
      stateEl.textContent = 'No entries yet. Be the first to conquer the board.';
      stateEl.style.display = 'block';
      return;
    }
    stateEl.style.display = 'none';
    let rank = 1;
    for(const item of rows){
      const tr = document.createElement('tr');

      const playerName = (item.player_name ?? '').toString();
      const titleName = playerName || 'Unknown Player';

      const beat = !!item.beat_the_game;
      const follower = !!item.acquired_follower;
      const score = typeof item.score === 'number' ? item.score : null;
      const updated = item.updated_at || item.created_at || null;

      // Build cells
      const cells = [
        { label: 'Rank', html: `<span class="rank">#${rank}</span>` },
        { label: 'Player', html: `<span class="player" title="${escapeHtml(titleName)}">${escapeHtml(titleName || '—')}</span>` },
        { label: 'Beat the Game', html: `<span class="pill ${beat ? 'yes' : 'no'}" title="${beat ? 'Beat the game' : 'Did not beat the game'}">${beat ? iconCheck+' Yes' : iconCross+' No'}</span>` },
        { label: 'Score', html: `<span class="score" title="${score !== null ? formatNumber(score) : '-'}">${score !== null ? formatNumber(score) : '-'}</span>` },
        { label: 'Acquired Follower', html: follower
            ? `<span title="Follower acquired" aria-label="Follower acquired" style="color:var(--success)">${iconCheck}</span>`
            : `<span title="No follower" aria-label="No follower" style="color:var(--danger)">${iconCross}</span>` },
        { label: 'Last Updated', html: `<span class="ts">${formatDate(updated)}</span>` },
      ];

      for(const c of cells){
        const td = document.createElement('td');
        td.setAttribute('data-label', c.label);
        td.innerHTML = c.html;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
      rank++;
    }
  }

  // HTML escaper for tooltips
  function escapeHtml(s){
    return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  }

  // Fetch + state
  let isFetching = false;
  let lastFetchAt = 0;
  async function fetchLeaderboard({ showSkeleton = false } = {}){
    if(isFetching) return;
    isFetching = true;
    if(showSkeleton) renderSkeleton(6);
    try{
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('player_name, beat_the_game, score, acquired_follower, updated_at, created_at')
        .order('beat_the_game', { ascending: false })
        .order('score', { ascending: false });

      if(error){
        showError(error.message || 'Failed to load leaderboard.');
        return;
      }
      renderRows(data || []);
      lastFetchAt = Date.now();
      updateLastSync();
    }catch(err){
      showError(err?.message || 'Unexpected error while fetching data.');
    }finally{
      isFetching = false;
    }
  }

  function showError(msg){
    tbody.innerHTML = '';
    stateEl.textContent = 'Error: ' + msg;
    stateEl.style.display = 'block';
  }

  function updateLastSync(){
    if(!lastFetchAt){ lastSyncEl.textContent = ''; return; }
    const d = new Date(lastFetchAt);
    lastSyncEl.textContent = 'Last sync: ' + d.toLocaleTimeString();
  }

  // Manual refresh (debounced)
  let refreshCooldown = false;
  refreshBtn.addEventListener('click', async ()=>{
    if(refreshCooldown) return;
    refreshCooldown = true;
    refreshBtn.setAttribute('disabled','true');
    await fetchLeaderboard({ showSkeleton: true });
    setTimeout(()=>{
      refreshCooldown = false;
      refreshBtn.removeAttribute('disabled');
    }, 1200);
  });

  // Clipboard copy
  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(CONTRACT_ADDRESS);
      showToast('Contract copied');
      announce('Contract address copied to clipboard');
    }catch{
      showToast('Copy failed');
    }
  });

  // Realtime subscription (INSERT & UPDATE)
  function setupRealtime(){
    try{
      const channel = supabase.channel('leaderboard_updates');
      channel.on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).subscribe((status)=>{/* noop */});
    }catch(e){
      // non-critical
    }
  }

  // Throttle auto-refresh to avoid spamming
  let autoRefreshPending = false;
  function scheduleAutoRefresh(){
    if(autoRefreshPending) return;
    autoRefreshPending = true;
    setTimeout(async ()=>{
      await fetchLeaderboard();
      autoRefreshPending = false;
    }, 800);
  }

  // FAQ modal logic with focus trap
  let lastFocusedBeforeModal = null;

  function openFaq(){
    lastFocusedBeforeModal = document.activeElement;
    faqOverlay.classList.add('open');
    faqOverlay.setAttribute('aria-hidden','false');
    // Focus first focusable in modal
    trapFocus(faqOverlay);
    const first = getFocusable(faqOverlay)[0];
    first?.focus();
    document.addEventListener('keydown', handleModalKeydown);
    // close on overlay click (outside)
    faqOverlay.addEventListener('mousedown', onOverlayClick);
  }

  function closeFaq(){
    faqOverlay.classList.remove('open');
    faqOverlay.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', handleModalKeydown);
    faqOverlay.removeEventListener('mousedown', onOverlayClick);
    // restore focus
    lastFocusedBeforeModal?.focus();
  }

  function onOverlayClick(e){
    const modal = faqOverlay.querySelector('.modal');
    if(!modal.contains(e.target)){
      closeFaq();
    }
  }

  function handleModalKeydown(e){
    if(e.key === 'Escape'){ e.preventDefault(); closeFaq(); return; }
    if(e.key === 'Tab'){ maintainTrapFocus(e); }
  }

  function getFocusable(root){
    return Array.from(root.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    )).filter(el => el.offsetParent !== null || el === document.activeElement);
  }

  function trapFocus(root){
    const f = getFocusable(root);
    // ensure focus ring
    root.setAttribute('tabindex','-1');
    return f;
  }

  function maintainTrapFocus(e){
    const focusables = getFocusable(faqOverlay);
    if(focusables.length === 0) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    const active = document.activeElement;
    if(e.shiftKey && active === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && active === last){ e.preventDefault(); first.focus(); }
  }

  helpBtn.addEventListener('click', openFaq);
  closeFaqBtn.addEventListener('click', closeFaq);

  // Initialize
  renderSkeleton(6);
  fetchLeaderboard().then(()=> setupRealtime());

  // Utility: update last-sync every minute
  setInterval(updateLastSync, 60000);

  // Guard: if config not set, show hint
  if(!SUPABASE_URL || SUPABASE_URL.includes('YOUR-PROJECT')){
    showToast('TODO: Configure Supabase');
  }

</script>
</body>
</html>