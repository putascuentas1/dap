<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dukes & Peasants ‚Äî Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-0: #0a0f14;
    --bg-1: #0f1620;
    --stroke: rgba(255,255,255,0.12);
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #00e5ff;
    --accent-2: #2aff80;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
    --radius: 14px;
    --radius-sm: 10px;
    --focus: 0 0 0 2px rgba(0,229,255,0.5), 0 0 0 6px rgba(0,229,255,0.15);
    --bottom-pad: 180px; /* dynamically updated */
  }

  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    background: var(--bg-0);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
    line-height: 1.6;
  }
  body { margin: 0; overflow-y: auto; }

  /* Ambient background */
  body::before, body::after {
    content: "";
    position: fixed; inset: 0;
    pointer-events: none; z-index: -2;
  }
  body::before {
    background:
      radial-gradient(60rem 60rem at 15% 10%, rgba(0,229,255,0.12), transparent 60%),
      radial-gradient(60rem 60rem at 85% 90%, rgba(42,255,128,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
  }
  body::after {
    background-image:
      linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 46px 46px, 46px 46px;
    mask-image: radial-gradient(80rem 80rem at 50% 50%, rgba(0,0,0,0.55), transparent 75%);
    animation: gridFloat 14s ease-in-out infinite alternate;
  }
  @keyframes gridFloat { from { transform: translateY(0) } to { transform: translateY(-10px) } }

  /* Header with logos and centered title */
  .topbar{
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(10,15,20,0.9), rgba(10,15,20,0.6));
    backdrop-filter: saturate(130%) blur(12px);
    border-bottom: 1px solid var(--stroke);
  }
  .top-container{ max-width: 1100px; margin: 0 auto; padding: 18px 20px; }
  .brand-row{
    display: grid;
    grid-template-columns: 48px 1fr 48px;
    align-items: center;
    gap: 14px;
  }
  .logo{
    width: 48px; height: 48px;
    filter: drop-shadow(0 0 14px rgba(0,229,255,0.35));
  }
  .title{
    font-family: Orbitron, Inter, sans-serif;
    font-weight: 700; letter-spacing: 0.6px; margin:0;
    font-size: clamp(1.4rem, 1.2rem + 2vw, 2.2rem);
    text-align: center;
    text-shadow: 0 0 20px rgba(0,229,255,0.2);
  }
  .neon-bar{ height: 2px; width: 100%; background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent); opacity: 0.5; }

  /* Main and top action bar (PLAY) */
  main { padding: 20px 20px var(--bottom-pad); max-width: 1100px; margin: 0 auto; transition: padding-bottom .2s ease; }
  .actions-top{
    display: flex; align-items: center; justify-content: flex-end;
    margin-bottom: 14px;
  }

  .btn{
    appearance: none; border: 1px solid var(--stroke); color: var(--text);
    background: rgba(255,255,255,0.04);
    padding: 10px 14px; border-radius: 12px; font-weight: 700; letter-spacing: 0.2px;
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    cursor: pointer; text-decoration: none; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{ background: rgba(255,255,255,0.08); transform: translateY(-1px); }
  .btn:focus-visible{ outline: none; box-shadow: var(--focus); }
  .btn-primary{
    border-color: rgba(0,229,255,0.45);
    background: linear-gradient(180deg, rgba(0,229,255,0.15), rgba(0,229,255,0.06));
  }
  .btn-primary:hover{
    background: linear-gradient(180deg, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    box-shadow: 0 0 24px rgba(0,229,255,0.25);
  }
  .btn-play{ padding: 12px 18px; font-size: 1rem; }

  /* Error banner */
  .error-banner{
    display:none;
    margin-bottom: 12px;
    padding: 10px 12px;
    border-radius: 12px;
    background: rgba(255,72,122,0.12);
    border: 1px solid rgba(255,72,122,0.45);
    color: #ffd6e3;
  }
  .error-banner.show{ display:block; }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px) saturate(140%);
    overflow: hidden;
  }

  /* Desktop table (visible >780px) */
  .table-wrap { width: 100%; overflow-x: hidden; }
  table {
    width: 100%;
    border-collapse: collapse;
    background: transparent;
    font-size: 0.98rem;
    table-layout: auto; /* adapt to viewport width */
  }
  thead th{
    text-align: left; font-weight: 700; color: #cfe7ff; padding: 14px 16px;
    position: sticky; top: 0; background: rgba(12,18,26,0.7); backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--stroke);
  }
  thead th.col-emoji { width: 48px; text-align: center; }
  thead th.col-rank { width: 72px; }
  tbody td{ padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); vertical-align: middle; }
  tbody td.col-emoji{ text-align: center; width: 48px; }
  tbody tr{ transition: background .15s ease; }
  tbody tr:nth-child(even){ background: rgba(255,255,255,0.02); }
  tbody tr:hover{ background: rgba(0,229,255,0.06); }

  .rank { font-weight: 700; color: #dffaff; display: inline-block; }
  .player { max-width: 340px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .address {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    letter-spacing: 0.2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    max-width: 280px; display: inline-block;
  }
  .score { font-variant-numeric: tabular-nums; font-weight: 700; }
  .crown { margin-left: 6px; }

  /* Mobile card-list (visible ‚â§780px) */
  .cards-wrap { display: none; padding: 8px 8px 14px; }
  .card-row{
    display: grid; gap: 6px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    padding: 12px 10px;
  }
  .cr-top{
    display: flex; align-items: center; justify-content: space-between; gap: 10px;
  }
  .cr-left{
    display: flex; align-items: center; gap: 10px; min-width: 0;
  }
  .cr-rank{ font-weight: 800; color: #dffaff; }
  .cr-name{
    min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700;
  }
  .cr-addr, .cr-score{
    font-size: 0.95rem; color: var(--muted);
  }
  .cr-addr .label { color: #cfe7ff; font-weight: 600; margin-right: 6px; }
  .cr-penguin{ margin-left: 8px; }
  .state { padding: 26px; text-align: center; color: var(--muted); }

  /* Skeleton loaders */
  .skeleton{
    height: 14px; border-radius: 8px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
  }
  .sk-rank{ width: 30px; }
  .sk-name{ width: 60%; }
  .sk-addr{ width: 50%; }
  .sk-score{ width: 80px; }
  .sk-emoji{ width: 20px; }
  @keyframes shimmer { 0%{ background-position: 200% 0 } 100%{ background-position: -200% 0 } }

  /* Bottom region (fixed) */
  .bottom-region{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 40;
    padding: 12px 14px 18px;
    display:flex; justify-content: center;
    background: linear-gradient(0deg, rgba(10,15,20,0.96), rgba(10,15,20,0.88), rgba(10,15,20,0));
    border-top: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
  }
  .bottom-wrap{ width: 100%; max-width: 1100px; display: grid; gap: 12px; }

  /* Contract + actions */
  .contract-row{
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 10px;
  }
  .contract-box{
    position: relative;
    display: block;
    padding: 12px 48px 12px 12px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--stroke);
    color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    cursor: pointer;
  }
  .contract-box:focus-visible{ outline: none; box-shadow: var(--focus); }
  .copy-svg{
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    width: 18px; height: 18px; opacity: 0.95;
  }

  .actions-stack{
    display: grid; grid-auto-flow: column; gap: 10px; align-items: center;
  }
  .btn-icon{ display:inline-flex; align-items:center; gap:8px; padding: 10px 12px; }
  .btn-icon img{ width: 18px; height: 18px; display: block; }

  /* Socials + FAQ row */
  .socials-row{ display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
  .socials-left{ display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; }
  .btn-icon-only{ width: 40px; height: 40px; padding: 0; justify-content: center; }
  .btn-icon-only img{ width: 20px; height: 20px; display: block; }
  .spacer{ flex: 1 1 auto; }
  .faq-btn{ white-space: nowrap; }

  /* Modal */
  .overlay{
    position: fixed; inset: 0; z-index: 100; display:none;
    background: rgba(5,8,12,0.7);
    backdrop-filter: blur(8px) saturate(120%);
  }
  .overlay.open{ display:block; }
  .modal{
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    width: min(760px, calc(100% - 32px));
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal-header{
    display:flex; justify-content: space-between; align-items:center; padding: 14px 16px;
    border-bottom: 1px solid var(--stroke);
  }
  .modal-title{ margin: 0; font-family: Orbitron, Inter, sans-serif; letter-spacing: 0.6px; }
  .modal-body{ max-height: min(70vh, 720px); overflow: auto; padding: 16px; }
  .faq{ display: grid; gap: 14px; }
  .faq-item{
    background: rgba(255,255,255,0.04); border: 1px solid var(--stroke);
    border-radius: var(--radius-sm); padding: 14px 14px;
  }
  .faq-item h4{ margin: 0 0 6px 0; }
  .close-btn{
    width: 36px; height: 36px; border-radius: 10px;
    display:grid; place-items:center;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.06);
    cursor: pointer;
  }
  .close-btn:hover{ background: rgba(255,255,255,0.1); }
  .close-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Toast */
  .toast{
    position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; z-index: 120;
    background: rgba(7,11,16,0.92); color: var(--text);
    border: 1px solid rgba(0,229,255,0.35);
    padding: 10px 14px; border-radius: 12px;
    display: none; align-items: center; gap: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  }
  .toast.show{ display: inline-flex; animation: toastIn .2s ease; }
  @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 6px) } to { opacity: 1; transform: translate(-50%, 0) } }

  /* Mobile layout ‚â§780px */
  @media (max-width: 780px){
    .brand-row{ grid-template-columns: 36px 1fr 36px; gap: 12px; }
    .logo{ width: 36px; height: 36px; }

    .actions-top{ justify-content: center; }
    .btn-play{ width: 100%; max-width: 320px; }

    /* Switch to card list; hide table */
    .table-wrap{ display: none; }
    .cards-wrap{ display: block; }

    /* Bottom actions: Chart + Buy side-by-side below contract */
    .contract-row{ grid-template-columns: 1fr; }
    .actions-stack{ grid-auto-flow: row; grid-template-columns: 1fr 1fr; }
    .btn { justify-content: center; }
    .btn-icon img{ width: 20px; height: 20px; }
  }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="top-container">
      <div class="brand-row" aria-label="Project brand">
        <img class="logo" src="assets/logo1.png" alt="Dukes & Peasants logo left" />
        <h1 class="title">Dukes &amp; Peasants</h1>
        <img class="logo" src="assets/logo2.png" alt="Dukes & Peasants logo right" />
      </div>
    </div>
    <div class="neon-bar" aria-hidden="true"></div>
  </header>

  <main id="main">
    <div id="errorBanner" class="error-banner" role="alert" aria-live="polite"></div>

    <!-- PLAY action bar inside main, above leaderboard -->
    <div class="actions-top">
      <a id="playBtn" class="btn btn-primary btn-play" href="#" target="_blank" rel="noopener noreferrer" aria-label="Play Dukes &amp; Peasants">PLAY</a>
    </div>

    <section class="card" aria-label="Leaderboard">
      <!-- Desktop table -->
      <div class="table-wrap" id="tableWrap">
        <table aria-describedby="leaderboard-desc">
          <caption id="leaderboard-desc" style="position:absolute;left:-9999px;opacity:0;">
            Sorted by Beat the Game (Yes first), then Best Score (descending), then Follower (Yes first).
          </caption>
          <thead>
            <tr>
              <th scope="col" class="col-rank">Rank</th>
              <th scope="col">Name</th>
              <th scope="col">Solana Address</th>
              <th scope="col">Best Score</th>
              <th scope="col" class="col-emoji"></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Skeleton rows inserted by JS -->
          </tbody>
        </table>
      </div>

      <!-- Mobile cards -->
      <div class="cards-wrap" id="cardsWrap" aria-label="Leaderboard (mobile)">
        <!-- Skeleton cards inserted by JS -->
      </div>

      <div id="state" class="state" style="display:none;"></div>
    </section>
  </main>

  <!-- Bottom Region (fixed) -->
  <div class="bottom-region" role="complementary" aria-label="Project links and contract info" id="bottomRegion">
    <div class="bottom-wrap">
      <div class="contract-row">
        <div id="contractBox" class="contract-box" tabindex="0" role="button" aria-label="Copy contract address" title="Click to copy">
          <span id="contractText"></span>
          <!-- Inline overlapping-squares copy icon -->
          <svg class="copy-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="9" y="9" width="11" height="11" rx="2" ry="2"></rect>
            <rect x="4" y="4" width="11" height="11" rx="2" ry="2"></rect>
          </svg>
        </div>
        <div class="actions-stack">
          <a id="chartBtn" class="btn btn-icon" target="_blank" rel="noopener noreferrer" aria-label="Open Dexscreener chart">
            <img src="assets/dexscreener.svg" alt="Dexscreener" />
            <span class="btn-label">Chart</span>
          </a>
          <a id="buyBtn" class="btn btn-icon" target="_blank" rel="noopener noreferrer" aria-label="Open Buy link">
            <img src="assets/pumpfun.svg" alt="Pump.fun" />
            <span class="btn-label">Buy</span>
          </a>
        </div>
      </div>

      <div class="socials-row" aria-label="Social links">
        <div class="socials-left">
          <a id="twitterLink" class="btn btn-icon-only" href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter">
            <img src="assets/twitter.svg" alt="Twitter" />
          </a>
          <a id="discordLink" class="btn btn-icon-only" href="#" target="_blank" rel="noopener noreferrer" aria-label="Discord">
            <img src="assets/discord.svg" alt="Discord" />
          </a>
          <a id="telegramLink" class="btn btn-icon-only" href="#" target="_blank" rel="noopener noreferrer" aria-label="Telegram">
            <img src="assets/telegram.svg" alt="Telegram" />
          </a>
        </div>
        <div class="spacer" aria-hidden="true"></div>
        <button id="faqBtn" class="btn faq-btn" aria-haspopup="dialog" aria-controls="faqOverlay" aria-label="Open FAQ" title="FAQ">FAQ</button>
      </div>
    </div>
  </div>

  <!-- FAQ Modal -->
  <div id="faqOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
      <div class="modal-header">
        <h3 id="faqTitle" class="modal-title">FAQ ‚Äî Dukes &amp; Peasants</h3>
        <button id="closeFaqBtn" class="close-btn" aria-label="Close FAQ" title="Close">
          <span aria-hidden="true">‚úï</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="faq">
          <div class="faq-item">
            <h4>How is the leaderboard sorted?</h4>
            <p>Players who beat the game appear first, then highest best score, then whether a follower was acquired.</p>
          </div>
          <div class="faq-item">
            <h4>What do the icons mean?</h4>
            <p>üëë appears beside a player‚Äôs name if they beat the game. üêß appears if they acquired a follower.</p>
          </div>
          <div class="faq-item">
            <h4>Why is my Solana address truncated?</h4>
            <p>For readability. Hover on desktop to see the full address on the tooltip.</p>
          </div>
          <div class="faq-item">
            <h4>How often does the table update?</h4>
            <p>It updates automatically via realtime changes, with a silent 60s fallback refresh.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I view the token chart or buy?</h4>
            <p>Use the Chart and Buy buttons in the bottom bar. They open in a new tab.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I find the community?</h4>
            <p>Links to Twitter, Discord, and Telegram are in the bottom bar.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast + SR live region -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <span id="toastMsg">Copied!</span>
  </div>
  <div id="srAnnounce" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-live="polite"></div>

<script type="module">
  // ESM-only import for Supabase
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Config constants
  const SUPABASE_URL = 'https://poxiozhybwvscgklmuhm.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBveGlvemh5Ynd2c2Nna2xtdWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NzM0NjQsImV4cCI6MjA3MzQ0OTQ2NH0.q2uAUAeaHzW3vYgoHlvJA_lAHYp5GK2AiLmIk9nFnvE';
  const TABLE_NAME = 'users_public';
  const CONTRACT_ADDRESS = 'PLACEHOLDER';
  const DEXSCREENER_URL = 'https://dexscreener.com/PLACEHOLDER';
  const BUY_URL = 'https://pump.fun/PLACEHOLDER';
  const TWITTER_URL = 'https://twitter.com/PLACEHOLDER';
  const DISCORD_URL = 'https://discord.gg/PLACEHOLDER';
  const TELEGRAM_URL = 'https://t.me/PLACEHOLDER';
  const PLAY_URL = 'https://telegram.org/PLACEHOLDER';

  // DOM references
  const tbody = document.getElementById('tbody');
  const cardsWrap = document.getElementById('cardsWrap');
  const stateEl = document.getElementById('state');
  const errorBanner = document.getElementById('errorBanner');

  const contractBox = document.getElementById('contractBox');
  const contractText = document.getElementById('contractText');

  const chartBtn = document.getElementById('chartBtn');
  const buyBtn = document.getElementById('buyBtn');

  const twitterLink = document.getElementById('twitterLink');
  const discordLink = document.getElementById('discordLink');
  const telegramLink = document.getElementById('telegramLink');
  const playBtn = document.getElementById('playBtn');

  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  const srAnnounce = document.getElementById('srAnnounce');

  const faqBtn = document.getElementById('faqBtn');
  const faqOverlay = document.getElementById('faqOverlay');
  const closeFaqBtn = document.getElementById('closeFaqBtn');

  const bottomRegion = document.getElementById('bottomRegion');

  // Apply config to DOM immediately (before any network)
  (function applyConfig() {
    try {
      contractText.textContent = CONTRACT_ADDRESS;
      chartBtn.href = DEXSCREENER_URL;
      buyBtn.href = BUY_URL;
      twitterLink.href = TWITTER_URL;
      discordLink.href = DISCORD_URL;
      telegramLink.href = TELEGRAM_URL;
      playBtn.href = PLAY_URL;
    } catch (_) {}
  })();

  // Bind UI handlers up-front (independent of data fetch)
  function announce(msg){
    srAnnounce.textContent = '';
    setTimeout(()=>{ srAnnounce.textContent = msg; }, 10);
  }
  let toastTimer = null;
  function showToast(message = 'Copied!'){
    toastMsg.textContent = message;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
  }

  async function copyContract(){
    try{
      await navigator.clipboard.writeText(CONTRACT_ADDRESS);
      showToast('Contract copied');
      announce('Contract address copied to clipboard');
    }catch{
      showToast('Copy failed');
    }
  }
  contractBox.addEventListener('click', copyContract);
  contractBox.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      copyContract();
    }
  });

  // FAQ modal controls + focus trap
  function getFocusable(root){
    return Array.from(root.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    )).filter(el => (el.offsetParent !== null) || el === document.activeElement);
  }
  function maintainTrapFocus(e){
    const focusables = getFocusable(faqOverlay);
    if(focusables.length === 0) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    const active = document.activeElement;
    if(e.shiftKey && active === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && active === last){ e.preventDefault(); first.focus(); }
  }
  function handleModalKeydown(e){
    if(e.key === 'Escape'){ e.preventDefault(); closeFaq(); return; }
    if(e.key === 'Tab'){ maintainTrapFocus(e); }
  }
  function onOverlayClick(e){
    const modal = faqOverlay.querySelector('.modal');
    if(!modal.contains(e.target)){ closeFaq(); }
  }
  function openFaq(){
    faqOverlay.classList.add('open');
    faqOverlay.setAttribute('aria-hidden','false');
    const first = getFocusable(faqOverlay)[0];
    first?.focus();
    document.addEventListener('keydown', handleModalKeydown);
    faqOverlay.addEventListener('mousedown', onOverlayClick);
  }
  function closeFaq(){
    faqOverlay.classList.remove('open');
    faqOverlay.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', handleModalKeydown);
    faqOverlay.removeEventListener('mousedown', onOverlayClick);
    faqBtn?.focus();
  }
  faqBtn.addEventListener('click', openFaq);
  closeFaqBtn.addEventListener('click', closeFaq);

  // Prevent footer overlap: adjust main padding-bottom to footer height
  function adjustBottomPadding(){
    try{
      const h = bottomRegion?.offsetHeight || 0;
      document.documentElement.style.setProperty('--bottom-pad', (h + 24) + 'px');
    }catch{}
  }
  window.addEventListener('resize', adjustBottomPadding);
  window.addEventListener('load', adjustBottomPadding);

  // Utility formatters
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>\"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  }
  const formatNumber = (n)=> typeof n === 'number' ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '-';
  function truncateAddressDesktop(addr){
    if(!addr) return '‚Äî';
    const s = String(addr);
    if(s.length <= 12) return s;
    return `${s.slice(0,6)}...${s.slice(-6)}`;
  }
  function truncateAddressMobile(addr){
    if(!addr) return '‚Äî';
    const s = String(addr);
    return s.length <= 6 ? s : `${s.slice(0,6)}...`;
  }

  // Skeletons
  function renderTableSkeleton(count = 6){
    stateEl.style.display = 'none';
    tbody.innerHTML = '';
    for(let i=0;i<count;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><div class="skeleton sk-rank"></div></td>
        <td><div class="skeleton sk-name"></div></td>
        <td><div class="skeleton sk-addr"></div></td>
        <td><div class="skeleton sk-score"></div></td>
        <td class="col-emoji"><div class="skeleton sk-emoji"></div></td>
      `;
      tbody.appendChild(tr);
    }
  }
  function renderCardsSkeleton(count = 6){
    stateEl.style.display = 'none';
    cardsWrap.innerHTML = '';
    for(let i=0;i<count;i++){
      const row = document.createElement('div');
      row.className = 'card-row';
      row.innerHTML = `
        <div class="cr-top">
          <div class="cr-left">
            <span class="cr-rank"><span class="skeleton sk-rank" style="display:inline-block;height:14px;"></span></span>
            <span class="cr-name"><span class="skeleton sk-name" style="display:inline-block;height:14px;"></span></span>
          </div>
          <span class="cr-penguin"><span class="skeleton sk-emoji" style="display:inline-block;height:14px;"></span></span>
        </div>
        <div class="cr-addr"><span class="label">Address</span><span class="skeleton sk-addr" style="display:inline-block;height:14px;"></span></div>
        <div class="cr-score"><span class="skeleton sk-score" style="display:inline-block;height:14px;"></span></div>
      `;
      cardsWrap.appendChild(row);
    }
  }

  // Rendering
  function renderTableRows(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length === 0){
      stateEl.textContent = 'No entries yet. Be the first to conquer the board.';
      stateEl.style.display = 'block';
      return;
    }
    stateEl.style.display = 'none';
    let rank = 1;
    for(const item of rows){
      const name = (item.name ?? '').toString();
      const fullAddr = item.sol_address ? String(item.sol_address) : '';
      const score = typeof item.best_score === 'number' ? item.best_score : null;
      const beat = !!item.has_beaten_game;
      const follower = !!item.has_follower;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="rank">#${rank}</span></td>
        <td><span class="player" title="${escapeHtml(name || '‚Äî')}">${escapeHtml(name || '‚Äî')}${beat ? ' <span class="crown" title="Beat the game" aria-label="Beat the game">üëë</span>' : ''}</span></td>
        <td><span class="address" title="${escapeHtml(fullAddr || '‚Äî')}">${escapeHtml(truncateAddressDesktop(fullAddr))}</span></td>
        <td><span class="score" title="${score !== null ? formatNumber(score) : '-'}">${score !== null ? formatNumber(score) : '-'}</span></td>
        <td class="col-emoji">${follower ? '<span role="img" aria-label="Has follower" title="Has follower">üêß</span>' : ''}</td>
      `;
      tbody.appendChild(tr);
      rank++;
    }
  }

  function renderCardRows(rows){
    cardsWrap.innerHTML = '';
    if(!rows || rows.length === 0){
      if (stateEl) { stateEl.textContent = 'No entries yet. Be the first to conquer the board.'; stateEl.style.display = 'block'; }
      return;
    }
    stateEl.style.display = 'none';
    let rank = 1;
    for(const item of rows){
      const name = (item.name ?? '').toString();
      const fullAddr = item.sol_address ? String(item.sol_address) : '';
      const score = typeof item.best_score === 'number' ? item.best_score : null;
      const beat = !!item.has_beaten_game;
      const follower = !!item.has_follower;

      const row = document.createElement('div');
      row.className = 'card-row';
      row.innerHTML = `
        <div class="cr-top">
          <div class="cr-left">
            <span class="cr-rank">#${rank}</span>
            <span class="cr-name" title="${escapeHtml(name || '‚Äî')}">${escapeHtml(name || '‚Äî')}${beat ? ' <span class="crown" title="Beat the game" aria-label="Beat the game">üëë</span>' : ''}</span>
          </div>
          <span class="cr-penguin">${follower ? '<span role="img" aria-label="Has follower" title="Has follower">üêß</span>' : ''}</span>
        </div>
        <div class="cr-addr" title="${escapeHtml(fullAddr || '‚Äî')}"><span class="label">Address</span>${escapeHtml(truncateAddressMobile(fullAddr))}</div>
        <div class="cr-score"><strong>Best Score:</strong> ${score !== null ? formatNumber(score) : '-'}</div>
      `;
      cardsWrap.appendChild(row);
      rank++;
    }
  }

  // Error handling
  function showErrorBanner(msg){
    if(!errorBanner) return;
    errorBanner.textContent = msg;
    errorBanner.classList.add('show');
  }
  function clearErrorBanner(){
    if(!errorBanner) return;
    errorBanner.textContent = '';
    errorBanner.classList.remove('show');
  }

  // Initialize Supabase client (guard)
  let supabase = null;
  try {
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } catch (e) {
    showErrorBanner('Failed to initialize data client.');
  }

  // Fetch and state
  let isFetching = false;
  async function fetchLeaderboard({ showSkeleton = false } = {}){
    if(!supabase){
      showErrorBanner('Data client not available.');
      return;
    }
    if(isFetching) return;
    isFetching = true;
    clearErrorBanner();
    if(showSkeleton){
      renderTableSkeleton(6);
      renderCardsSkeleton(6);
    }
    try{
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('user_id, name, sol_address, best_score, has_beaten_game, has_follower, updated_at')
        .order('has_beaten_game', { ascending: false })
        .order('best_score', { ascending: false })
        .order('has_follower', { ascending: false });

      if(error){
        showErrorBanner('Failed to load leaderboard.');
        return;
      }
      renderTableRows(data || []);
      renderCardRows(data || []);
      adjustBottomPadding();
    }catch(err){
      showErrorBanner('Unexpected error while fetching data.');
    }finally{
      isFetching = false;
    }
  }

  // Realtime subscription + fallback polling
  let channel = null;
  function setupRealtime(){
    if(!supabase) return;
    try{
      channel = supabase.channel('users_public_changes')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: TABLE_NAME }, scheduleAutoRefresh)
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: TABLE_NAME }, scheduleAutoRefresh)
        .subscribe();
    }catch(e){
      // non-critical
    }
  }
  window.addEventListener('beforeunload', ()=> { try{ channel?.unsubscribe(); }catch{} });

  let autoRefreshPending = false;
  function scheduleAutoRefresh(){
    if(autoRefreshPending) return;
    autoRefreshPending = true;
    setTimeout(async ()=>{
      await fetchLeaderboard();
      autoRefreshPending = false;
    }, 400);
  }
  setInterval(()=> { fetchLeaderboard(); }, 60000);

  // Init
  renderTableSkeleton(6);
  renderCardsSkeleton(6);
  fetchLeaderboard({ showSkeleton: false }).then(()=> setupRealtime());
  adjustBottomPadding();
</script>
</body>
</html>