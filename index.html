<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dukes & Peasants ‚Äî Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-0: #0a0f14;
    --bg-1: #0f1620;
    --stroke: rgba(255,255,255,0.12);
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #00e5ff;
    --accent-2: #2aff80;
    --danger: #ff487a;
    --success: #2aff80;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
    --radius: 14px;
    --radius-sm: 10px;
    --focus: 0 0 0 2px rgba(0,229,255,0.5), 0 0 0 6px rgba(0,229,255,0.15);
  }

  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    background: var(--bg-0);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
    line-height: 1.6;
  }
  body { margin: 0; overflow-y: auto; }

  /* Ambient background */
  body::before, body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -2;
  }
  body::before {
    background:
      radial-gradient(60rem 60rem at 15% 10%, rgba(0,229,255,0.12), transparent 60%),
      radial-gradient(60rem 60rem at 85% 90%, rgba(42,255,128,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
  }
  body::after {
    background-image:
      linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 46px 46px, 46px 46px;
    mask-image: radial-gradient(80rem 80rem at 50% 50%, rgba(0,0,0,0.55), transparent 75%);
    animation: gridFloat 14s ease-in-out infinite alternate;
  }
  @keyframes gridFloat { from { transform: translateY(0) } to { transform: translateY(-10px) } }

  /* Top banner */
  .topbar {
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(10,15,20,0.9), rgba(10,15,20,0.6));
    backdrop-filter: saturate(130%) blur(12px);
    border-bottom: 1px solid var(--stroke);
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 18px 20px; }
  .brand { display:flex; align-items:flex-start; gap:14px; }
  .crest {
    width: 44px; height: 44px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2));
    box-shadow: 0 0 24px rgba(0,229,255,0.45), inset 0 0 22px rgba(42,255,128,0.3);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .title {
    font-family: Orbitron, Inter, sans-serif;
    font-weight: 700; letter-spacing: 0.6px; margin:0;
    font-size: clamp(1.2rem, 1.4rem + 1vw, 2rem);
    display:flex; align-items:center; gap:8px;
    text-shadow: 0 0 20px rgba(0,229,255,0.2);
  }
  .subtitle { margin: 2px 0 0 0; font-size: 0.95rem; color: var(--muted); }
  .neon-bar { height: 2px; width: 100%; background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent); opacity: 0.5; }

  /* Main layout */
  main { padding: 28px 20px 140px; max-width: 1100px; margin: 0 auto; }
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px) saturate(140%);
    overflow: hidden;
  }
  .card-header {
    display:flex; align-items:center; justify-content: space-between;
    padding: 16px 18px; border-bottom: 1px solid var(--stroke);
  }
  .card-title { margin: 0; font-size: 1.1rem; color: var(--muted); letter-spacing: 0.3px; }
  .actions { display:flex; align-items:center; gap:10px; }

  .btn {
    appearance: none; border: 1px solid var(--stroke); color: var(--text);
    background: rgba(255,255,255,0.04);
    padding: 10px 14px; border-radius: 12px; font-weight: 600; letter-spacing: 0.2px;
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    cursor: pointer;
  }
  .btn:hover { background: rgba(255,255,255,0.08); transform: translateY(-1px); }
  .btn:focus-visible { outline: none; box-shadow: var(--focus); }
  .btn-primary {
    border-color: rgba(0,229,255,0.45);
    background: linear-gradient(180deg, rgba(0,229,255,0.15), rgba(0,229,255,0.06));
  }
  .btn-primary:hover {
    background: linear-gradient(180deg, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    box-shadow: 0 0 24px rgba(0,229,255,0.25);
  }
  .btn[disabled]{ opacity: 0.55; cursor: not-allowed; }
  .btn-icon { display:inline-flex; align-items:center; gap:8px; }

  .last-sync { color: var(--muted); font-size: 0.88rem; }

  /* Table */
  .table-wrap { width: 100%; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; background: transparent; font-size: 0.98rem; }
  thead th {
    text-align: left; font-weight: 700; color: #cfe7ff; padding: 14px 16px;
    position: sticky; top: 0; background: rgba(12,18,26,0.7); backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--stroke);
  }
  tbody td { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
  tbody tr { transition: background .15s ease; }
  tbody tr:nth-child(even){ background: rgba(255,255,255,0.02); }
  tbody tr:hover{ background: rgba(0,229,255,0.06); }

  .player { max-width: 340px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .address { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing: 0.2px; }
  .score { font-variant-numeric: tabular-nums; font-weight: 700; }

  /* Emoji badge styling for visibility */
  .badge {
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 28px; height: 28px; border-radius: 8px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.10);
    font-size: 16px;
  }
  .badge-empty { opacity: 0.55; }

  /* State + skeleton */
  .state { padding: 26px; text-align: center; color: var(--muted); }

  .skeleton {
    height: 14px; border-radius: 8px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
  }
  .sk1{ width: 60%; }      /* name */
  .sk2{ width: 180px; }    /* address */
  .sk3{ width: 80px; }     /* score */
  .sk4{ width: 60px; }     /* crown */
  .sk5{ width: 60px; }     /* penguin */
  @keyframes shimmer { 0%{ background-position: 200% 0 } 100%{ background-position: -200% 0 } }

  /* Bottom region (not a footer) */
  .bottom-region{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 40;
    padding: 12px 14px 18px;
    display:flex; justify-content: center;
    background: linear-gradient(0deg, rgba(10,15,20,0.96), rgba(10,15,20,0.88), rgba(10,15,20,0));
    border-top: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
  }
  .bottom-wrap{
    width: 100%; max-width: 1100px;
    display: grid; grid-template-columns: 1fr auto; gap: 12px;
    align-items: start;
  }
  .contract-group{
    display: grid; grid-template-columns: 1fr auto auto; gap: 10px; width: 100%;
  }
  .input{
    width: 100%; padding: 12px 12px; border-radius: 12px;
    background: rgba(255,255,255,0.06); color: var(--text);
    border: 1px solid var(--stroke); font-family: inherit; font-size: 0.98rem;
  }
  .input[readonly]{ color: #d7eaff; }
  .btn-chart{ white-space: nowrap; }

  .socials{
    grid-column: 1 / -1;
    display:flex; align-items:center; gap: 10px;
    margin-top: 6px; flex-wrap: wrap;
  }
  .social-btn{
    display:inline-flex; align-items:center; gap:10px;
    padding: 10px 12px; border-radius: 999px; text-decoration: none;
    color: var(--text); border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.04);
    transition: transform .15s ease, background .2s, box-shadow .2s ease;
  }
  .social-btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.08); }
  .social-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Floating FAQ button */
  .help-btn{
    position: fixed; right: 18px; bottom: 96px; z-index: 45;
    width: 54px; height: 54px; border-radius: 50%;
    display:grid; place-items:center;
    border: 1px solid rgba(0,229,255,0.35);
    background: radial-gradient(circle at 30% 30%, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    color: var(--text);
    box-shadow: 0 0 22px rgba(0,229,255,0.2);
  }
  .help-btn:hover{ box-shadow: 0 0 28px rgba(0,229,255,0.3); transform: translateY(-1px); }
  .help-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Modal */
  .overlay{
    position: fixed; inset: 0; z-index: 100; display:none;
    background: rgba(5,8,12,0.7);
    backdrop-filter: blur(8px) saturate(120%);
  }
  .overlay.open{ display:block; }
  .modal{
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    width: min(760px, calc(100% - 32px));
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal-header{
    display:flex; justify-content: space-between; align-items:center; padding: 14px 16px;
    border-bottom: 1px solid var(--stroke);
  }
  .modal-title{ margin: 0; font-family: Orbitron, Inter, sans-serif; letter-spacing: 0.6px; }
  .modal-body{ max-height: min(70vh, 720px); overflow: auto; padding: 16px; }
  .faq{ display: grid; gap: 14px; }
  .faq-item{
    background: rgba(255,255,255,0.04); border: 1px solid var(--stroke);
    border-radius: var(--radius-sm); padding: 14px 14px;
  }
  .faq-item h4{ margin: 0 0 6px 0; }
  .close-btn{
    width: 36px; height: 36px; border-radius: 10px;
    display:grid; place-items:center;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.06);
    cursor: pointer;
  }
  .close-btn:hover{ background: rgba(255,255,255,0.1); }
  .close-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Toast */
  .toast{
    position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; z-index: 120;
    background: rgba(7,11,16,0.92); color: var(--text);
    border: 1px solid rgba(0,229,255,0.35);
    padding: 10px 14px; border-radius: 12px;
    display: none; align-items: center; gap: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  }
  .toast.show{ display: inline-flex; animation: toastIn .2s ease; }
  @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 6px) } to { opacity: 1; transform: translate(-50%, 0) } }

  /* Responsive: stack table rows on small screens */
  @media (max-width: 780px){
    thead{ display: none; }
    table, tbody, tr, td{ display: block; width: 100%; }
    tbody tr{ border-bottom: 1px solid rgba(255,255,255,0.06); padding: 10px 6px; }
    tbody td{
      border: none; padding: 8px 10px;
      display:flex; justify-content: space-between; align-items:center; gap: 12px;
    }
    tbody td::before{
      content: attr(data-label);
      color: var(--muted); font-weight: 600; letter-spacing: 0.3px;
    }
    .player { max-width: none; }
    .bottom-wrap{ grid-template-columns: 1fr; gap: 10px; }
    .contract-group{ grid-template-columns: 1fr auto; grid-auto-rows: auto; }
  }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="container">
      <div class="brand" aria-label="Project brand">
        <div class="crest" aria-hidden="true" title="Project crest glow"></div>
        <div>
          <h1 class="title">Dukes &amp; Peasants <span style="color:var(--accent)">‚Ä¢</span></h1>
          <p class="subtitle">A high-stakes on-chain tale‚Äîrise from peasant to duke and etch your name on the board.</p>
        </div>
      </div>
    </div>
    <div class="neon-bar" aria-hidden="true"></div>
  </header>

  <main id="main">
    <section class="card" aria-label="Leaderboard">
      <div class="card-header">
        <h2 class="card-title">Leaderboard</h2>
        <div class="actions">
          <span class="last-sync" id="lastSync" aria-live="polite"></span>
          <button id="refreshBtn" class="btn btn-icon" aria-label="Refresh leaderboard" title="Refresh">
            <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="18" height="18">
              <path d="M21 12a9 9 0 1 1-2.64-6.36" />
              <path d="M21 3v6h-6" />
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table aria-describedby="leaderboard-desc">
          <caption id="leaderboard-desc" style="position:absolute;left:-9999px;opacity:0;">
            Sorted by Beat the Game (Yes first), then by Best Score (descending), then by Follower (Yes first).
          </caption>
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Sol Address</th>
              <th scope="col">Best Score</th>
              <th scope="col">Beat the Game</th>
              <th scope="col">Acquired Follower</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Skeleton rows rendered by JS -->
          </tbody>
        </table>
      </div>
      <div id="state" class="state" style="display:none;"></div>
    </section>
  </main>

  <!-- Bottom Region (no footer) -->
  <div class="bottom-region" role="complementary" aria-label="Project links and contract info">
    <div class="bottom-wrap">
      <div class="contract-group">
        <input id="contractInput" class="input" type="text" readonly value="" aria-label="Contract address (readonly)" title="Contract address" />
        <button id="copyBtn" class="btn btn-icon" aria-label="Copy contract address" title="Copy">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="16" height="16">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <a id="chartBtn" class="btn btn-primary btn-icon btn-chart" target="_blank" rel="noopener noreferrer" aria-label="Open Dexscreener chart in new tab" title="Dexscreener">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="16" height="16">
            <path d="M18 13V6a2 2 0 0 0-2-2H6" />
            <rect x="8" y="8" width="12" height="12" rx="2" />
            <path d="M12 12l3 3 4-5" />
          </svg>
          Chart
        </a>

        <div class="socials" aria-label="Social links">
          <a id="twitterLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter" title="Twitter">
            <span aria-hidden="true">ùïè</span> Twitter
          </a>
          <a id="discordLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Discord" title="Discord">
            <span aria-hidden="true">üí¨</span> Discord
          </a>
          <a id="telegramLink" class="social-btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Telegram" title="Telegram">
            <span aria-hidden="true">‚úàÔ∏è</span> Telegram
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Help Button -->
  <button id="helpBtn" class="help-btn" aria-haspopup="dialog" aria-controls="faqOverlay" aria-label="Open FAQ" title="FAQ">
    <svg class="icon icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="18" height="18">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M9.1 9.5a3 3 0 0 1 5.7 1c0 2-3 2-3 4"></path>
      <circle cx="12" cy="17" r="0.8" fill="currentColor" stroke="none"></circle>
    </svg>
  </button>

  <!-- FAQ Modal -->
  <div id="faqOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
      <div class="modal-header">
        <h3 id="faqTitle" class="modal-title">FAQ ‚Äî Dukes &amp; Peasants</h3>
        <button id="closeFaqBtn" class="close-btn" aria-label="Close FAQ" title="Close">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" width="16" height="16">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="faq">
          <div class="faq-item">
            <h4>What is Dukes &amp; Peasants?</h4>
            <p>A choice-driven, on-chain adventure where players compete for glory. Your decisions affect your score and whether you beat the game.</p>
          </div>
          <div class="faq-item">
            <h4>How is the leaderboard sorted?</h4>
            <p>By players who beat the game first, then highest best score, then whether a follower was acquired.</p>
          </div>
          <div class="faq-item">
            <h4>What do the icons mean?</h4>
            <p>üëë means you beat the game; üêß means you acquired a follower. A dash ‚Äî means the condition was not met.</p>
          </div>
          <div class="faq-item">
            <h4>Why is my address truncated?</h4>
            <p>We show first and last 6 characters for readability. Hover to see the full address in a tooltip.</p>
          </div>
          <div class="faq-item">
            <h4>How often is the data updated?</h4>
            <p>You can refresh manually, and new/updated entries auto-refresh shortly after they occur via realtime updates.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I view the token chart?</h4>
            <p>Use the Chart button at the bottom to open the Dexscreener page in a new tab.</p>
          </div>
          <div class="faq-item">
            <h4>Who maintains this project?</h4>
            <p>The Dukes &amp; Peasants team and community. Join us on Twitter, Discord, and Telegram via the links at the bottom.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast + SR live region -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <span id="toastMsg">Copied!</span>
  </div>
  <div id="srAnnounce" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-live="polite"></div>

<script type="module">
  // Config: hardcoded constants
  const SUPABASE_URL = 'https://poxiozhybwvscgklmuhm.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBveGlvemh5Ynd2c2Nna2xtdWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NzM0NjQsImV4cCI6MjA3MzQ0OTQ2NH0.q2uAUAeaHzW3vYgoHlvJA_lAHYp5GK2AiLmIk9nFnvE';
  const TABLE_NAME = 'users_public';
  const CONTRACT_ADDRESS = 'PLACEHOLDER';
  const DEXSCREENER_URL = 'https://dexscreener.com/PLACEHOLDER';
  const TWITTER_URL = 'https://twitter.com/PLACEHOLDER';
  const DISCORD_URL = 'https://discord.gg/PLACEHOLDER';
  const TELEGRAM_URL = 'https://t.me/PLACEHOLDER';

  // ESM-only Supabase import
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Initialize client
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM references
  const tbody = document.getElementById('tbody');
  const stateEl = document.getElementById('state');
  const refreshBtn = document.getElementById('refreshBtn');
  const lastSyncEl = document.getElementById('lastSync');
  const contractInput = document.getElementById('contractInput');
  const copyBtn = document.getElementById('copyBtn');
  const chartBtn = document.getElementById('chartBtn');
  const twitterLink = document.getElementById('twitterLink');
  const discordLink = document.getElementById('discordLink');
  const telegramLink = document.getElementById('telegramLink');
  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  const srAnnounce = document.getElementById('srAnnounce');
  const helpBtn = document.getElementById('helpBtn');
  const faqOverlay = document.getElementById('faqOverlay');
  const closeFaqBtn = document.getElementById('closeFaqBtn');

  // Apply config immediately to UI
  contractInput.value = CONTRACT_ADDRESS;
  chartBtn.href = DEXSCREENER_URL;
  twitterLink.href = TWITTER_URL;
  discordLink.href = DISCORD_URL;
  telegramLink.href = TELEGRAM_URL;

  // Helpers
  function announce(msg){
    srAnnounce.textContent = '';
    setTimeout(()=>{ srAnnounce.textContent = msg; }, 10);
  }
  let toastTimer = null;
  function showToast(message = 'Copied!'){
    toastMsg.textContent = message;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
  }
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>\"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));
  }
  const formatNumber = (n)=> typeof n === 'number' ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '-';
  function truncateAddress(addr){
    if(!addr) return '‚Äî';
    const s = String(addr);
    if(s.length <= 12) return s;
    return `${s.slice(0,6)}...${s.slice(-6)}`;
  }

  // Skeleton
  function renderSkeleton(count = 6){
    stateEl.style.display = 'none';
    tbody.innerHTML = '';
    for(let i=0;i<count;i++){
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Name"><div class="skeleton sk1"></div></td>
        <td data-label="Sol Address"><div class="skeleton sk2"></div></td>
        <td data-label="Best Score"><div class="skeleton sk3"></div></td>
        <td data-label="Beat the Game"><div class="skeleton sk4"></div></td>
        <td data-label="Acquired Follower"><div class="skeleton sk5"></div></td>
      `;
      tbody.appendChild(row);
    }
  }

  // Render rows
  function renderRows(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length === 0){
      stateEl.textContent = 'No entries yet. Be the first to conquer the board.';
      stateEl.style.display = 'block';
      return;
    }
    stateEl.style.display = 'none';

    for(const item of rows){
      const tr = document.createElement('tr');

      const name = (item.name ?? '').toString();
      const fullAddr = item.sol_address ? String(item.sol_address) : '';
      const addrDisplay = truncateAddress(fullAddr);
      const score = typeof item.best_score === 'number' ? item.best_score : null;
      const beat = !!item.has_beaten_game;
      const follower = !!item.has_follower;

      const cells = [
        { label: 'Name', html: `<span class="player" title="${escapeHtml(name || '‚Äî')}">${escapeHtml(name || '‚Äî')}</span>` },
        { label: 'Sol Address', html: `<span class="address" title="${escapeHtml(fullAddr || '‚Äî')}">${escapeHtml(addrDisplay)}</span>` },
        { label: 'Best Score', html: `<span class="score" title="${score !== null ? formatNumber(score) : '-'}">${score !== null ? formatNumber(score) : '-'}</span>` },
        { label: 'Beat the Game', html: beat
            ? `<span class="badge" role="img" aria-label="Beat the game" title="Beat the game">üëë</span>`
            : `<span class="badge badge-empty" aria-label="Not beaten yet" title="Not beaten yet">‚Äî</span>` },
        { label: 'Acquired Follower', html: follower
            ? `<span class="badge" role="img" aria-label="Has follower" title="Has follower">üêß</span>`
            : `<span class="badge badge-empty" aria-label="No follower" title="No follower">‚Äî</span>` },
      ];

      for(const c of cells){
        const td = document.createElement('td');
        td.setAttribute('data-label', c.label);
        td.innerHTML = c.html;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }
  }

  // Fetch + state
  let isFetching = false;
  let lastFetchAt = 0;

  async function fetchLeaderboard({ showSkeleton = false } = {}){
    if(isFetching) return;
    isFetching = true;
    if(showSkeleton) renderSkeleton(6);
    try{
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('user_id, name, sol_address, best_score, has_beaten_game, has_follower, updated_at')
        .order('has_beaten_game', { ascending: false })
        .order('best_score', { ascending: false })
        .order('has_follower', { ascending: false });

      if(error){
        showError(error.message || 'Failed to load leaderboard.');
        return;
      }
      renderRows(data || []);
      lastFetchAt = Date.now();
      updateLastSync();
    }catch(err){
      showError(err?.message || 'Unexpected error while fetching data.');
    }finally{
      isFetching = false;
    }
  }

  function showError(msg){
    tbody.innerHTML = '';
    stateEl.textContent = 'Error: ' + msg;
    stateEl.style.display = 'block';
  }

  function updateLastSync(){
    if(!lastFetchAt){ lastSyncEl.textContent = ''; return; }
    const d = new Date(lastFetchAt);
    lastSyncEl.textContent = 'Last sync: ' + d.toLocaleTimeString();
  }

  // Manual refresh
  let refreshCooldown = false;
  refreshBtn.addEventListener('click', async ()=>{
    if(refreshCooldown) return;
    refreshCooldown = true;
    refreshBtn.setAttribute('disabled','true');
    await fetchLeaderboard({ showSkeleton: true });
    setTimeout(()=>{
      refreshCooldown = false;
      refreshBtn.removeAttribute('disabled');
    }, 900);
  });

  // Clipboard copy
  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(CONTRACT_ADDRESS);
      showToast('Contract copied');
      announce('Contract address copied to clipboard');
    }catch{
      showToast('Copy failed');
    }
  });

  // Realtime subscription (INSERT & UPDATE)
  let channel = null;
  function setupRealtime(){
    try{
      channel = supabase.channel('users_public_changes');
      channel.on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).subscribe();
    }catch(e){ /* non-critical */ }
  }
  // Clean up on unload
  window.addEventListener('beforeunload', ()=> { try{ channel?.unsubscribe(); }catch{} });

  // Throttled auto-refresh
  let autoRefreshPending = false;
  function scheduleAutoRefresh(){
    if(autoRefreshPending) return;
    autoRefreshPending = true;
    setTimeout(async ()=>{
      await fetchLeaderboard();
      autoRefreshPending = false;
    }, 800);
  }

  // FAQ modal: open/close + focus trap
  let lastFocusedBeforeModal = null;

  function getFocusable(root){
    return Array.from(root.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    )).filter(el => (el.offsetParent !== null) || el === document.activeElement);
  }
  function maintainTrapFocus(e){
    const focusables = getFocusable(faqOverlay);
    if(focusables.length === 0) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    const active = document.activeElement;
    if(e.shiftKey && active === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && active === last){ e.preventDefault(); first.focus(); }
  }
  function handleModalKeydown(e){
    if(e.key === 'Escape'){ e.preventDefault(); closeFaq(); return; }
    if(e.key === 'Tab'){ maintainTrapFocus(e); }
  }
  function onOverlayClick(e){
    const modal = faqOverlay.querySelector('.modal');
    if(!modal.contains(e.target)){ closeFaq(); }
  }

  function openFaq(){
    lastFocusedBeforeModal = document.activeElement;
    faqOverlay.classList.add('open');
    faqOverlay.setAttribute('aria-hidden','false');
    const first = getFocusable(faqOverlay)[0];
    first?.focus();
    document.addEventListener('keydown', handleModalKeydown);
    faqOverlay.addEventListener('mousedown', onOverlayClick);
  }
  function closeFaq(){
    faqOverlay.classList.remove('open');
    faqOverlay.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', handleModalKeydown);
    faqOverlay.removeEventListener('mousedown', onOverlayClick);
    lastFocusedBeforeModal?.focus();
  }

  helpBtn.addEventListener('click', openFaq);
  closeFaqBtn.addEventListener('click', closeFaq);

  // Init
  renderSkeleton(6);
  fetchLeaderboard().then(()=> setupRealtime());
  setInterval(updateLastSync, 60000);

  // Gentle hint if placeholders still present
  if(!SUPABASE_URL || SUPABASE_URL.includes('YOUR-PROJECT')){
    showToast('TODO: Configure Supabase');
  }
</script>
</body>
</html>