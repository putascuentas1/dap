<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dukes & Peasants — Leaderboard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg-0: #0a0f14;
    --bg-1: #0f1620;
    --stroke: rgba(255,255,255,0.12);
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #00e5ff;
    --accent-2: #2aff80;
    --shadow: 0 10px 30px rgba(0,0,0,0.4);
    --radius: 14px;
    --radius-sm: 10px;
    --focus: 0 0 0 2px rgba(0,229,255,0.5), 0 0 0 6px rgba(0,229,255,0.15);
  }

  * { box-sizing: border-box; }
  html, body {
    height: 100%;
    background: var(--bg-0);
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol", sans-serif;
    line-height: 1.6;
  }
  body { margin: 0; overflow-y: auto; }

  /* Ambient background */
  body::before, body::after {
    content: "";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: -2;
  }
  body::before {
    background:
      radial-gradient(60rem 60rem at 15% 10%, rgba(0,229,255,0.12), transparent 60%),
      radial-gradient(60rem 60rem at 85% 90%, rgba(42,255,128,0.10), transparent 60%),
      linear-gradient(180deg, var(--bg-1), var(--bg-0));
  }
  body::after {
    background-image:
      linear-gradient(rgba(255,255,255,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.04) 1px, transparent 1px);
    background-size: 46px 46px, 46px 46px;
    mask-image: radial-gradient(80rem 80rem at 50% 50%, rgba(0,0,0,0.55), transparent 75%);
    animation: gridFloat 14s ease-in-out infinite alternate;
  }
  @keyframes gridFloat { from { transform: translateY(0) } to { transform: translateY(-10px) } }

  /* Top banner: centered title + subtitle, crests on both sides */
  .topbar{
    position: sticky; top: 0; z-index: 50;
    background: linear-gradient(180deg, rgba(10,15,20,0.9), rgba(10,15,20,0.6));
    backdrop-filter: saturate(130%) blur(12px);
    border-bottom: 1px solid var(--stroke);
  }
  .top-container{
    max-width: 1100px; margin: 0 auto; padding: 18px 20px;
  }
  .brand-row{
    display: grid; grid-template-columns: 48px 1fr 48px; align-items: center; column-gap: 14px;
  }
  .crest{
    width: 48px; height: 48px; border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2));
    box-shadow: 0 0 24px rgba(0,229,255,0.45), inset 0 0 22px rgba(42,255,128,0.3);
    border: 1px solid rgba(255,255,255,0.08);
  }
  .brand-center{
    text-align: center;
  }
  .title{
    font-family: Orbitron, Inter, sans-serif;
    font-weight: 700; letter-spacing: 0.6px; margin:0;
    font-size: clamp(1.2rem, 1.4rem + 1vw, 2rem);
    text-shadow: 0 0 20px rgba(0,229,255,0.2);
  }
  .subtitle{
    margin: 6px 0 0 0; font-size: 0.95rem; color: var(--muted);
  }
  .neon-bar{ height: 2px; width: 100%; background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent); opacity: 0.5; }

  /* Main layout */
  main { padding: 28px 20px 150px; max-width: 1100px; margin: 0 auto; }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.04));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(14px) saturate(140%);
    overflow: hidden;
  }

  /* Table (no header bar/title) */
  .table-wrap { width: 100%; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; background: transparent; font-size: 0.98rem; }
  thead th {
    text-align: left; font-weight: 700; color: #cfe7ff; padding: 14px 16px;
    position: sticky; top: 0; background: rgba(12,18,26,0.7); backdrop-filter: blur(8px);
    border-bottom: 1px solid var(--stroke);
  }
  thead th.col-emoji { width: 48px; text-align: center; }
  tbody td { padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.06); }
  tbody td.col-emoji { text-align: center; }
  tbody tr { transition: background .15s ease; }
  tbody tr:nth-child(even){ background: rgba(255,255,255,0.02); }
  tbody tr:hover{ background: rgba(0,229,255,0.06); }

  .player { max-width: 420px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .address { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing: 0.2px; }
  .score { font-variant-numeric: tabular-nums; font-weight: 700; }

  .crown { margin-left: 6px; }

  /* State + skeleton (4 columns) */
  .state { padding: 26px; text-align: center; color: var(--muted); }
  .skeleton {
    height: 14px; border-radius: 8px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.14), rgba(255,255,255,0.06));
    background-size: 200% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
  }
  .sk1{ width: 60%; }      /* name */
  .sk2{ width: 200px; }    /* address */
  .sk3{ width: 90px; }     /* score */
  .sk4{ width: 20px; margin: 0 auto; }  /* penguin column */
  @keyframes shimmer { 0%{ background-position: 200% 0 } 100%{ background-position: -200% 0 } }

  /* Bottom region (not a footer) */
  .bottom-region{
    position: fixed; left: 0; right: 0; bottom: 0; z-index: 40;
    padding: 12px 14px 18px;
    display:flex; justify-content: center;
    background: linear-gradient(0deg, rgba(10,15,20,0.96), rgba(10,15,20,0.88), rgba(10,15,20,0));
    border-top: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
  }
  .bottom-wrap{
    width: 100%; max-width: 1100px;
    display: grid; grid-template-columns: 1fr; gap: 12px;
    align-items: start;
  }
  .contract-group{
    display: grid; grid-template-columns: 1fr auto auto; gap: 10px; width: 100%;
  }
  .input{
    width: 100%; padding: 12px 12px; border-radius: 12px;
    background: rgba(255,255,255,0.06); color: var(--text);
    border: 1px solid var(--stroke); font-family: inherit; font-size: 0.98rem;
  }
  .input[readonly]{ color: #d7eaff; }
  .btn{
    appearance: none; border: 1px solid var(--stroke); color: var(--text);
    background: rgba(255,255,255,0.04);
    padding: 10px 14px; border-radius: 12px; font-weight: 600; letter-spacing: 0.2px;
    transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    cursor: pointer; text-decoration: none; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{ background: rgba(255,255,255,0.08); transform: translateY(-1px); }
  .btn:focus-visible{ outline: none; box-shadow: var(--focus); }
  .btn-primary{
    border-color: rgba(0,229,255,0.45);
    background: linear-gradient(180deg, rgba(0,229,255,0.15), rgba(0,229,255,0.06));
  }
  .btn-primary:hover{
    background: linear-gradient(180deg, rgba(0,229,255,0.22), rgba(0,229,255,0.08));
    box-shadow: 0 0 24px rgba(0,229,255,0.25);
  }
  .btn-chart{ white-space: nowrap; }

  .socials-row{
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  }
  .socials-left{
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  }
  .spacer{ flex: 1 1 auto; } /* pushes FAQ to right */
  .faq-btn { white-space: nowrap; }

  /* Social icon sizes */
  .icon{ width: 16px; height: 16px; }
  .icon-lg{ width: 18px; height: 18px; }

  /* Modal */
  .overlay{
    position: fixed; inset: 0; z-index: 100; display:none;
    background: rgba(5,8,12,0.7);
    backdrop-filter: blur(8px) saturate(120%);
  }
  .overlay.open{ display:block; }
  .modal{
    position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
    width: min(760px, calc(100% - 32px));
    background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05));
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal-header{
    display:flex; justify-content: space-between; align-items:center; padding: 14px 16px;
    border-bottom: 1px solid var(--stroke);
  }
  .modal-title{ margin: 0; font-family: Orbitron, Inter, sans-serif; letter-spacing: 0.6px; }
  .modal-body{ max-height: min(70vh, 720px); overflow: auto; padding: 16px; }
  .faq{ display: grid; gap: 14px; }
  .faq-item{
    background: rgba(255,255,255,0.04); border: 1px solid var(--stroke);
    border-radius: var(--radius-sm); padding: 14px 14px;
  }
  .faq-item h4{ margin: 0 0 6px 0; }
  .close-btn{
    width: 36px; height: 36px; border-radius: 10px;
    display:grid; place-items:center;
    border: 1px solid var(--stroke);
    background: rgba(255,255,255,0.06);
    cursor: pointer;
  }
  .close-btn:hover{ background: rgba(255,255,255,0.1); }
  .close-btn:focus-visible{ outline: none; box-shadow: var(--focus); }

  /* Toast */
  .toast{
    position: fixed; left: 50%; transform: translateX(-50%); bottom: 24px; z-index: 120;
    background: rgba(7,11,16,0.92); color: var(--text);
    border: 1px solid rgba(0,229,255,0.35);
    padding: 10px 14px; border-radius: 12px;
    display: none; align-items: center; gap: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.35);
  }
  .toast.show{ display: inline-flex; animation: toastIn .2s ease; }
  @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 6px) } to { opacity: 1; transform: translate(-50%, 0) } }

  /* Responsive */
  @media (max-width: 780px){
    thead{ display: none; }
    table, tbody, tr, td{ display: block; width: 100%; }
    tbody tr{ border-bottom: 1px solid rgba(255,255,255,0.06); padding: 10px 6px; }
    tbody td{
      border: none; padding: 8px 10px;
      display:flex; justify-content: space-between; align-items:center; gap: 12px;
    }
    tbody td::before{
      content: attr(data-label);
      color: var(--muted); font-weight: 600; letter-spacing: 0.3px;
    }
    tbody td.col-emoji::before{ content: ""; } /* no label for emoji column */
    .player { max-width: none; }
    .brand-row{ grid-template-columns: 36px 1fr 36px; }
    .crest{ width: 36px; height: 36px; }
    .bottom-wrap{ gap: 10px; }
    .contract-group{ grid-template-columns: 1fr auto; grid-auto-rows: auto; }
  }
</style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="top-container">
      <div class="brand-row" aria-label="Project brand">
        <div class="crest" aria-hidden="true" title="Project crest glow"></div>
        <div class="brand-center">
          <h1 class="title">Dukes &amp; Peasants</h1>
          <p class="subtitle">A high-stakes on-chain tale—rise from peasant to duke and etch your name on the board.</p>
        </div>
        <div class="crest" aria-hidden="true" title="Project crest glow"></div>
      </div>
    </div>
    <div class="neon-bar" aria-hidden="true"></div>
  </header>

  <main id="main">
    <section class="card" aria-label="Leaderboard">
      <div class="table-wrap" id="tableWrap">
        <table aria-describedby="leaderboard-desc">
          <caption id="leaderboard-desc" style="position:absolute;left:-9999px;opacity:0;">
            Sorted by Beat the Game (Yes first), then Best Score (descending), then Follower (Yes first).
          </caption>
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Solana Address</th>
              <th scope="col">Best Score</th>
              <th scope="col" class="col-emoji"></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- Skeleton rows rendered by JS -->
          </tbody>
        </table>
      </div>
      <div id="state" class="state" style="display:none;"></div>
    </section>
  </main>

  <!-- Bottom Region (no footer) -->
  <div class="bottom-region" role="complementary" aria-label="Project links and contract info">
    <div class="bottom-wrap">
      <div class="contract-group">
        <input id="contractInput" class="input" type="text" readonly value="" aria-label="Contract address (readonly)" title="Contract address" />
        <button id="copyBtn" class="btn" aria-label="Copy contract address" title="Copy">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <a id="chartBtn" class="btn btn-primary btn-chart" target="_blank" rel="noopener noreferrer" aria-label="Open Dexscreener chart in new tab" title="Dexscreener">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 13V6a2 2 0 0 0-2-2H6" />
            <rect x="8" y="8" width="12" height="12" rx="2" />
            <path d="M12 12l3 3 4-5" />
          </svg>
          Chart
        </a>
      </div>

      <div class="socials-row" aria-label="Social links">
        <div class="socials-left">
          <!-- Twitter (X) -->
          <a id="twitterLink" class="btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter (X)" title="Twitter (X)">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
              <path d="M3 3h4.7l4 5.6L17.7 3H21l-7.3 9.8L21 21h-4.7l-4.4-6.2L6.3 21H3l7.6-10.2L3 3z"></path>
            </svg>
            Twitter
          </a>
          <!-- Discord -->
          <a id="discordLink" class="btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Discord" title="Discord">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
              <path d="M20.317 4.369A18.144 18.144 0 0 0 15.89 3l-.36.75a13.166 13.166 0 0 1 3.264 1.206 11.47 11.47 0 0 0-3.99-1.266 12.78 12.78 0 0 0-4.612.076c-1.59.31-2.73.77-3.99 1.26.91-.44 2.04-.91 3.28-1.21L9.12 3A18.18 18.18 0 0 0 3.68 4.37C1.57 7.52.88 10.57.88 13.57c0 0 2.34 3.53 8.53 3.72l1.04-1.42c-.66-.24-1.32-.56-1.98-.96 1.82 1.08 3.86 1.7 6.08 1.7s4.26-.62 6.08-1.7c-.66.4-1.32.72-1.98.96l1.04 1.42c6.19-.19 8.53-3.72 8.53-3.72 0-3-0.69-6.05-2.81-9.2zM9.5 13.5c-.9 0-1.62-.8-1.62-1.77 0-.98.72-1.77 1.62-1.77.9 0 1.63.8 1.63 1.77 0 .98-.73 1.77-1.63 1.77zm5 0c-.9 0-1.63-.8-1.63-1.77 0-.98.73-1.77 1.63-1.77.9 0 1.62.8 1.62 1.77 0 .98-.72 1.77-1.62 1.77z"/>
            </svg>
            Discord
          </a>
          <!-- Telegram -->
          <a id="telegramLink" class="btn" href="#" target="_blank" rel="noopener noreferrer" aria-label="Telegram" title="Telegram">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
              <path d="M21.94 4.66c.18-.84-.64-1.55-1.44-1.25L2.7 10.17c-.95.36-.94 1.66.03 2l5.2 1.82 2.02 6.18c.28.87 1.4 1.09 1.99.37l2.89-3.5 5.12 3.75c.9.52 1.98.06 2.21-.98l3.78-15.15zM9.52 15.1l-.26 3.77 1.2-2.3 7.2-8.35-8.14 6.88z"/>
            </svg>
            Telegram
          </a>
        </div>
        <div class="spacer" aria-hidden="true"></div>
        <button id="faqBtn" class="btn faq-btn" aria-haspopup="dialog" aria-controls="faqOverlay" aria-label="Open FAQ" title="FAQ">FAQ</button>
      </div>
    </div>
  </div>

  <!-- FAQ Modal -->
  <div id="faqOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
      <div class="modal-header">
        <h3 id="faqTitle" class="modal-title">FAQ — Dukes &amp; Peasants</h3>
        <button id="closeFaqBtn" class="close-btn" aria-label="Close FAQ" title="Close">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 6L6 18"></path>
            <path d="M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="faq">
          <div class="faq-item">
            <h4>How is the leaderboard sorted?</h4>
            <p>By players who beat the game first, then highest best score, then whether a follower was acquired.</p>
          </div>
          <div class="faq-item">
            <h4>What do the icons mean?</h4>
            <p>👑 appears beside a player’s name if they beat the game. 🐧 shows in the last column if they acquired a follower.</p>
          </div>
          <div class="faq-item">
            <h4>Why is my Solana address truncated?</h4>
            <p>We show first and last 6 characters for readability. Hover the address to see the full value in a tooltip.</p>
          </div>
          <div class="faq-item">
            <h4>How often does the table update?</h4>
            <p>It updates automatically on database changes via realtime, with a silent 60s fallback poll to keep data fresh.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I view the token chart?</h4>
            <p>Use the Chart button at the bottom to open the Dexscreener page in a new tab.</p>
          </div>
          <div class="faq-item">
            <h4>Where can I find the community?</h4>
            <p>Links to Twitter (X), Discord, and Telegram are in the bottom bar.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast + SR live region -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <span id="toastMsg">Copied!</span>
  </div>
  <div id="srAnnounce" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;" aria-live="polite"></div>

<script type="module">
  // Config: hardcoded constants
  const SUPABASE_URL = 'https://poxiozhybwvscgklmuhm.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBveGlvemh5Ynd2c2Nna2xtdWhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NzM0NjQsImV4cCI6MjA3MzQ0OTQ2NH0.q2uAUAeaHzW3vYgoHlvJA_lAHYp5GK2AiLmIk9nFnvE';
  const TABLE_NAME = 'users_public';
  const CONTRACT_ADDRESS = 'PLACEHOLDER';
  const DEXSCREENER_URL = 'https://dexscreener.com/PLACEHOLDER';
  const TWITTER_URL = 'https://twitter.com/PLACEHOLDER';
  const DISCORD_URL = 'https://discord.gg/PLACEHOLDER';
  const TELEGRAM_URL = 'https://t.me/PLACEHOLDER';

  // ESM Supabase
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // Initialize client
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // DOM references
  const tbody = document.getElementById('tbody');
  const stateEl = document.getElementById('state');
  const contractInput = document.getElementById('contractInput');
  const copyBtn = document.getElementById('copyBtn');
  const chartBtn = document.getElementById('chartBtn');
  const twitterLink = document.getElementById('twitterLink');
  const discordLink = document.getElementById('discordLink');
  const telegramLink = document.getElementById('telegramLink');
  const toast = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMsg');
  const srAnnounce = document.getElementById('srAnnounce');
  const faqBtn = document.getElementById('faqBtn');
  const faqOverlay = document.getElementById('faqOverlay');
  const closeFaqBtn = document.getElementById('closeFaqBtn');

  // Apply config immediately to UI
  contractInput.value = CONTRACT_ADDRESS;
  chartBtn.href = DEXSCREENER_URL;
  twitterLink.href = TWITTER_URL;
  discordLink.href = DISCORD_URL;
  telegramLink.href = TELEGRAM_URL;

  // Helpers
  function announce(msg){
    srAnnounce.textContent = '';
    setTimeout(()=>{ srAnnounce.textContent = msg; }, 10);
  }
  let toastTimer = null;
  function showToast(message = 'Copied!'){
    toastMsg.textContent = message;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
  }
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>\"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;', "'":'&#39;' }[m]));
  }
  const formatNumber = (n)=> typeof n === 'number' ? n.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '-';
  function truncateAddress(addr){
    if(!addr) return '—';
    const s = String(addr);
    if(s.length <= 12) return s;
    return `${s.slice(0,6)}...${s.slice(-6)}`;
  }

  // Skeleton
  function renderSkeleton(count = 6){
    stateEl.style.display = 'none';
    tbody.innerHTML = '';
    for(let i=0;i<count;i++){
      const row = document.createElement('tr');
      row.innerHTML = `
        <td data-label="Name"><div class="skeleton sk1"></div></td>
        <td data-label="Solana Address"><div class="skeleton sk2"></div></td>
        <td data-label="Best Score"><div class="skeleton sk3"></div></td>
        <td class="col-emoji"><div class="skeleton sk4"></div></td>
      `;
      tbody.appendChild(row);
    }
  }

  // Render rows
  function renderRows(rows){
    tbody.innerHTML = '';
    if(!rows || rows.length === 0){
      stateEl.textContent = 'No entries yet. Be the first to conquer the board.';
      stateEl.style.display = 'block';
      return;
    }
    stateEl.style.display = 'none';

    for(const item of rows){
      const tr = document.createElement('tr');

      const name = (item.name ?? '').toString();
      const fullAddr = item.sol_address ? String(item.sol_address) : '';
      const addrDisplay = truncateAddress(fullAddr);
      const score = typeof item.best_score === 'number' ? item.best_score : null;
      const beat = !!item.has_beaten_game;
      const follower = !!item.has_follower;

      const nameHtml = `${escapeHtml(name || '—')}${beat ? ' <span class="crown" title="Beat the game" aria-label="Beat the game">👑</span>' : ''}`;

      const cells = [
        { label: 'Name', html: `<span class="player" title="${escapeHtml(name || '—')}">${nameHtml}</span>` },
        { label: 'Solana Address', html: `<span class="address" title="${escapeHtml(fullAddr || '—')}">${escapeHtml(addrDisplay)}</span>` },
        { label: 'Best Score', html: `<span class="score" title="${score !== null ? formatNumber(score) : '-'}">${score !== null ? formatNumber(score) : '-'}</span>` },
        { label: '', html: follower ? `<span role="img" aria-label="Has follower" title="Has follower">🐧</span>` : '', emoji: true }
      ];

      for(const c of cells){
        const td = document.createElement('td');
        td.setAttribute('data-label', c.label);
        if (c.emoji) td.classList.add('col-emoji');
        td.innerHTML = c.html;
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    }
  }

  // Fetch + state
  let isFetching = false;
  async function fetchLeaderboard({ showSkeleton = false } = {}){
    if(isFetching) return;
    isFetching = true;
    if(showSkeleton) renderSkeleton(6);
    try{
      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select('user_id, name, sol_address, best_score, has_beaten_game, has_follower, updated_at')
        .order('has_beaten_game', { ascending: false })
        .order('best_score', { ascending: false })
        .order('has_follower', { ascending: false });

      if(error){
        showError(error.message || 'Failed to load leaderboard.');
        return;
      }
      renderRows(data || []);
    }catch(err){
      showError(err?.message || 'Unexpected error while fetching data.');
    }finally{
      isFetching = false;
    }
  }

  function showError(msg){
    tbody.innerHTML = '';
    stateEl.textContent = 'Error: ' + msg;
    stateEl.style.display = 'block';
  }

  // Clipboard copy
  copyBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(CONTRACT_ADDRESS);
      showToast('Contract copied');
      announce('Contract address copied to clipboard');
    }catch{
      showToast('Copy failed');
    }
  });

  // Realtime subscription (INSERT & UPDATE)
  let channel = null;
  function setupRealtime(){
    try{
      channel = supabase.channel('users_public_changes');
      channel.on('postgres_changes',
        { event: 'INSERT', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).on('postgres_changes',
        { event: 'UPDATE', schema: 'public', table: TABLE_NAME },
        scheduleAutoRefresh
      ).subscribe();
    }catch(e){ /* non-critical */ }
  }
  // Cleanup on unload
  window.addEventListener('beforeunload', ()=> { try{ channel?.unsubscribe(); }catch{} });

  // Throttled auto-refresh for realtime events
  let autoRefreshPending = false;
  function scheduleAutoRefresh(){
    if(autoRefreshPending) return;
    autoRefreshPending = true;
    setTimeout(async ()=>{
      await fetchLeaderboard();
      autoRefreshPending = false;
    }, 500);
  }

  // Fallback polling every 60s
  setInterval(()=> { fetchLeaderboard(); }, 60000);

  // FAQ modal: open/close + focus trap
  let lastFocusedBeforeModal = null;

  function getFocusable(root){
    return Array.from(root.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    )).filter(el => (el.offsetParent !== null) || el === document.activeElement);
  }
  function maintainTrapFocus(e){
    const focusables = getFocusable(faqOverlay);
    if(focusables.length === 0) return;
    const first = focusables[0];
    const last = focusables[focusables.length - 1];
    const active = document.activeElement;
    if(e.shiftKey && active === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && active === last){ e.preventDefault(); first.focus(); }
  }
  function handleModalKeydown(e){
    if(e.key === 'Escape'){ e.preventDefault(); closeFaq(); return; }
    if(e.key === 'Tab'){ maintainTrapFocus(e); }
  }
  function onOverlayClick(e){
    const modal = faqOverlay.querySelector('.modal');
    if(!modal.contains(e.target)){ closeFaq(); }
  }

  function openFaq(){
    lastFocusedBeforeModal = document.activeElement;
    faqOverlay.classList.add('open');
    faqOverlay.setAttribute('aria-hidden','false');
    const first = getFocusable(faqOverlay)[0];
    first?.focus();
    document.addEventListener('keydown', handleModalKeydown);
    faqOverlay.addEventListener('mousedown', onOverlayClick);
  }
  function closeFaq(){
    faqOverlay.classList.remove('open');
    faqOverlay.setAttribute('aria-hidden','true');
    document.removeEventListener('keydown', handleModalKeydown);
    faqOverlay.removeEventListener('mousedown', onOverlayClick);
    lastFocusedBeforeModal?.focus();
  }

  faqBtn.addEventListener('click', openFaq);
  closeFaqBtn.addEventListener('click', closeFaq);

  // Init
  renderSkeleton(6);
  fetchLeaderboard().then(()=> setupRealtime());
</script>
</body>
</html>